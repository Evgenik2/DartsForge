<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="Description" content="The darts calculator.">
		<title>Darts Forge</title>
		<link href="styles.css" rel="stylesheet" type="text/css" />
		<link href="flags.css" rel="stylesheet" type="text/css" />
		<link href="menu.css" rel="stylesheet" type="text/css" />
		<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
		<link rel="manifest" href="site.webmanifest">
		<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
		<meta name="apple-mobile-web-app-title" content="DartsForge">
		<meta name="application-name" content="DartsForge">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
		<script>
			let deferredPrompt;
			window.addEventListener('beforeinstallprompt', event => {
				event.preventDefault();
				deferredPrompt = event;
				document.querySelector('#banner').addEventListener('click', event => {
					deferredPrompt.prompt();
					deferredPrompt.userChoice.then((choiceResult) => {
						if (choiceResult.outcome === 'accepted') {
							document.querySelector('#banner').style.display = 'none';
							console.log('User accepted the A2HS prompt');
						} else {
							console.log('User dismissed the A2HS prompt');
						}
						deferredPrompt = null;
					});
					deferredPrompt.preventDefault();
				});
				//document.querySelector('#banner-close').addEventListener('click', event => {
				//	document.querySelector('#banner').style.display = 'none';
				//	event.preventDefault();
				//});
				document.querySelector('#banner').style.display = 'flex';
			});
			var module = {};
		</script>
		<script src="Chart.min.js"></script>
		<script src="amazon-cognito-auth.min.js"></script>
		<script src="Serverless/Game501.js"></script>
		<script src="fittext.js"></script>
		<script src="vue.min.js"></script>
		<script src="swipe.js"></script>
		<script src="endings.js"></script>
		<script src="indexedDB.js"></script>
		<script src="settings.js"></script>
		<script src="language.js"></script>
		<script src="vueComponents.js"></script>
		<script src="flags.js"></script>
		<link href="media.css" rel="stylesheet" type="text/css" />
		<script>
			var currentView = 0;
			var userLang = navigator.language || navigator.userLanguage; 
			if(userLang == "ru-RU")
				settings.language = "ru";
			function registerServiceWorker() {
				var root = "/DartsForge/";
				if ('serviceWorker' in navigator) {
					try {
						navigator.serviceWorker.register('sw.js', { scope: root }).then(() => {
							console.log('Service Worker registered successfully.');
						}).catch(error => {
							console.log('Service Worker registration failed:', error);
						});
					}catch(e) {
						currentView = -1;
					}
				}
			}
			registerServiceWorker();
		</script>
		<style>
			.menu-collapsed {
				display: none;
			}
			.element-hidden {
				visibility: hidden;
			}
			.element-collapsed {
				display: none;
			}
			.element-visible {
				display: block;
			}
			.element-shored {
				opacity: 0.5;
			}
		</style>
	</head>
	<body>
		<div id="app" class="app">
			<div id="caption" class="caption" v-bind:class="{ 'menu-collapsed': currentView < 0 || currentView == 0 && !menuShown }">
				<div class="menucaption">
					<div class="menubannerbtn bannerSmall" id="banner" href="_">
						<svg class="menubannersvg" viewBox="0 0 210 297" style="fill:black;fill-opacity:0.1;fill-rule:nonzero;stroke-width:10;">
							<rect width="126.24404" height="213.17857" x="45.357143" y="43" rx="20" ry="20"/>
							<path d="M 49.066034,220.95591 H 167.75055"/>
							<circle cx="107.61691" cy="237.97665" r="2.2678571" />
							<path d="m 106.58929,100.45238 v 58.20833" style="stroke-width:30;"/>
							<path d="m 107.0027,172.7167 -17.021533,-29.48214 34.043043,-10e-6 z" style="stroke-width:30;"/>
							<path d="M 46.715494,75.411456 H 170.73893"/>
						</svg>
					</div>
					<div class="menubannerbtn bannerSmall element-visible" v-on:click="changeViewBack();" >
						<svg class="menubannerbackbtn" viewBox="0 0 210 297" style="fill:black;fill-opacity:0.1;fill-rule:nonzero;stroke-width:50;">
							<path d="m 120,80 -100,100 100,100"/>
						</svg>
					</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 0 }">{{language.menuInGame}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 1 }">{{language.menuHistory}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 2 }">{{language.menuHistory}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 3 }">{{language.menuProfile}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 4 }">{{language.communitiesNews}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 5 }">{{language.createCommunity}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 6 }">{{language.courtCommunity}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 7 }">{{language.changeCommunity}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 8 }">{{language.communityRating}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 10 }">{{language.menuCommunityEvents}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 11 }">{{language.menuCommunityEventsNew}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 12 }">{{language.publishGame}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 13 }">{{language.menuEvent}}</div>
					<div v-bind:class="{ 'menu-collapsed': currentView != 14 }">{{language.menuEventGame}}</div>
				</div>
				<div class="dropdown" v-bind:class="{ 'menu-collapsed': !wait }" >
					<div class="menudropbtn">
						<svg class="menudropsvg menuelement" viewBox="0 0 210 297">
							<path class="menudropsvgpath menuelement" 
							style="fill:black;fill-opacity:0.1;fill-rule:nonzero;stroke-width:40;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;" 
							d="M 195,185 A 90,90 0 0 1 140,270 90,90 0 0 1 40,250 90,90 0 0 1 20,150 90,90 0 0 1 105,95">
							<animateTransform attributeName="transform"
							attributeType="XML"
							type="rotate"
							from="0 100 185"
							to="360 100 185"
							dur="2s"
							repeatCount="indefinite"/>
						</path>
						</svg>
					</div>
				</div>
				<div class="dropdown" v-bind:class="{ 'menu-collapsed': !userName || !community || (waitingAgreement.length == 0 && waitingJoining.length == 0) }">
					<div class="menudropbtn" v-on:click="toggleMenuShow('notificationDropdown');">
						<svg class="menudropsvg menuelement" viewBox="0 0 210 250">
							<path class="menudropsvgpath menuelement" 
							style="fill:black;fill-opacity:0.1;fill-rule:nonzero;stroke-width:30;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;" 
							d="M 187.47095,223.0899 C 175.01539,244.05169 36.855117,242.31807 24.929451,221.05034 13.003783,199.78261 83.585284,80.99911 107.96651,81.305043 c 24.38122,0.305933 91.96,120.823057 79.50444,141.784857 z"/>
						</svg>
					</div>
					<div id="notificationDropdown" class="dropdown-content dropdown-content-bell">
						<communities-component-waitingAgreement  is="communities-component-waitingAgreement" v-for="item in waitingAgreement" v-bind:item="item" v-bind:key="item.name"></communities-component-waitingAgreement>
						<communities-component-waitingJoining  is="communities-component-waitingJoining" v-for="item in waitingJoining" v-bind:item="item" v-bind:key="item.name"></communities-component-waitingJoining>
					</div>
				</div>
				<div class="dropdown" v-bind:class="{ 'menu-collapsed': !userName || community }">
					<div class="menudropbtn" v-on:click="toggleMenuShow('communityDropdown');">
						<div class="menubtnContent">
							<div class="menuelement">{{language.menuSelectCommunity}}</div>
							<div class="menudroparrow menuelement">▼</div>
						</div>
					</div>
					<div id="communityDropdown" class="dropdown-content">
						<div class="dropdown-content-item" v-bind:class="{ 'menu-collapsed': (!profile.OwnedCommunities || profile.OwnedCommunities.length == 0) && (!profile.JoinedCommunities || profile.JoinedCommunities.length == 0) }" v-on:click="changeView(7); event.preventDefault();">{{language.changeCommunity}} </div>
						<div class="dropdown-content-item" v-bind:class="{ 'menu-collapsed': !profile.OwnedCommunities || profile.OwnedCommunities.length != 0}" v-on:click="changeView(5); event.preventDefault();">{{language.createCommunity}} </div>
						<div class="dropdown-content-item" v-on:click="requestCommunitiesList(); changeView(6); event.preventDefault();">{{language.courtCommunity}} </div>
					</div>
				</div>
				<div class="dropdown" v-bind:class="{ 'menu-collapsed': !userName || !community}">
					<div class="menudropbtn" v-on:click="toggleMenuShow('communityDropdown2');">
						<div class="menubtnContent">
							<div class="menuelement">{{community}}</div>
							<div class="menudroparrow menuelement">▼</div>
						</div>
					</div>
					<div id="communityDropdown2" class="dropdown-content">
						<div class="dropdown-content-item" v-on:click="changeView(0); event.preventDefault();">{{language.menuInGame}}</div> 
						<div class="dropdown-content-item" v-on:click="updateCommunityData(); changeView(8); event.preventDefault();">{{language.communityRating}} </div>
						<div class="dropdown-content-item" v-on:click="changeView(10); event.preventDefault();">{{language.menuCommunityEvents}}</div> 
						<div class="dropdown-content-item" v-bind:class="{ 'menu-collapsed': (!profile.OwnedCommunities || profile.OwnedCommunities.length == 0) && (!profile.JoinedCommunities || profile.JoinedCommunities.length == 0) }" v-on:click="changeView(7); event.preventDefault();">{{language.changeCommunity}} </div>
						<div class="dropdown-content-item" v-bind:class="{ 'menu-collapsed': !profile.OwnedCommunities || profile.OwnedCommunities.length != 0}" v-on:click="changeView(5); event.preventDefault();">{{language.createCommunity}} </div>
						<div class="dropdown-content-item" v-on:click="requestCommunitiesList(); changeView(6); event.preventDefault();">{{language.courtCommunity}} </div>
					</div>
				</div>
				<div class="menudropbtn" v-bind:class="{ 'menu-collapsed': userName }" v-on:click="logIn();">{{language.menuLoginSignin}}</div>
				<div class="dropdown" v-bind:class="{ 'menu-collapsed': !userName }">
					<div class="menudropbtn" v-on:click="toggleMenuShow('userDropdown');">
						<div class="menubtnContent">
							<div class="menuelement">{{userName}}</div>
							<div class="menudroparrow menuelement">▼</div>
						</div>
					</div>
					<div id="userDropdown" class="dropdown-content">
						<div class="dropdown-content-item" v-on:click="changeView(3); event.preventDefault();">{{language.menuProfile}}</div>
						<!--<div class="dropdown-content-item menuelement" v-on:click="changeMarkerView(); event.preventDefault();" v-bind:class="{ 'menu-collapsed': markerView }">{{language.menuMarkerViewOn}}</div>
						<div class="dropdown-content-item menuelement" v-on:click="changeMarkerView(); event.preventDefault();" v-bind:class="{ 'menu-collapsed': !markerView }">{{language.menuMarkerViewOff}}</div>-->
						<div class="dropdown-content-item menuelement" v-on:click="changeEnding(); event.preventDefault();">{{endings}}</div>
						<div class="dropdown-content-item menuelement" v-on:click="changeLanguage(); event.preventDefault();"><i :class="[language.flag]"></i> {{language.language}}</div>
						<!--<div class="dropdown-content-item" v-on:click="showHistory()">{{language.menuHistory}}</div>-->
						<div class="dropdown-content-item" v-bind:class="{ 'menu-collapsed': !userName }" href="_" v-on:click="logOut(); event.preventDefault();">{{language.menuLogout}}</div> 
					</div>
				</div>
			</div>
			<div class="history" v-bind:class="{ 'menu-collapsed': currentView != -1 }">
				<div>Turn off translator and reload the page. Отключите переводчик сайтов и перезагрузите страницу.</div>
			</div>
			<div id="event" class="history" v-bind:class="{ 'menu-collapsed': currentView != 13 }">
				<div class="history-container">
					<div class="events-row stats-row-wide">
						<div class="stats-row-header">HC</div>
						<div class="stats-row-header-middle">{{eventData.HC}}</div>
						<div>{{eventData.HCPlayer}}</div>
					</div>
					<div class="events-row stats-row-wide">
						<div class="stats-row-header">BL</div>
						<div class="stats-row-header-middle">{{eventData.BestLeg}}</div>
						<div>{{eventData.BestLegPlayer}}</div>
					</div>
					<div class="events-row stats-row-wide">
						<div class="stats-row-header">{{language.historyTotal}}</div>
						<div class="stats-row-header-middle">{{eventHistory.length}}</div>
					</div>
					<div class="history-data">
						<history-component  is="history-component" v-for="item in eventHistory" kind="event" v-bind:item="item" v-bind:key="item.timeStamp"></history-component>
					</div>
				</div>
			</div>
			<div id="eventGame" class="history" v-bind:class="{ 'menu-collapsed': currentView != 14 }">
				<div class="history-container">
					<div class="history-data">
						<div class="events-row stats-row">
							<div class="stats-row-header">{{language.menuSets}}</div>
							<div>{{eventHistoryItemList[0].setLength}}</div>
						</div>
						<div class="events-row stats-row">
							<div class="stats-row-header">{{language.menuLegs}}</div>
							<div>{{eventHistoryItemList[0].legLength}}</div>
						</div>
						<div class="events-row stats-row">
							<div class="stats-row-header">{{language.menuGame}}</div>
							<div>{{eventHistoryItemList[0].gameLength}}</div>
						</div>
						<history-component  is="history-component" v-for="item in eventHistoryItemList" v-bind:item="item" v-bind:key="item.timeStamp">
						</history-component>
						<game-set-component is="game-set-component" v-for="item in eventHistoryItemLegs" v-bind:item="item" v-bind:key="item.leg">
						</game-set-component>
					</div>
				</div>
			</div>
			<div id="manageCommunity" class="profile" v-bind:class="{ 'menu-collapsed': currentView != 8 }">
				<div class="history-container">
					<communities-component-communityRating  is="communities-component-communityRating" v-for="item in communityData.Rating" v-bind:item="item" v-bind:key="item.name"></communities-component-communityRating>		
				</div>
			</div>
			<div id="communityEvents" class="profile" v-bind:class="{ 'menu-collapsed': currentView != 10 }">
				<div class="history-container">
					<div class="menu-row">
						<a class="dropdown-content-item" class="loginButton" href="_" v-on:click="changeView(11); event.preventDefault();">{{language.menuCommunityEventsNew}}</a> 						
					</div>
					<div class="events-row"> 
						<div class="community-rating community-rating-header	">
							<div class="community-rating-event-group">
								<div class="community-rating-rating">{{language.opened}}</div>
							</div>
							<div class="community-rating-event-group">
								<div class="community-rating-event">{{language.eventName}}</div>
							</div>
							<div class="community-rating-event-group community-rating-event-group-short">
								<div class="community-rating-event">HC</div>
							</div>
							<div class="community-rating-event-group community-rating-event-group-short">
								<div class="community-rating-event">BL</div>
							</div>
							<div class="community-rating-userName"></div>
							<div class="community-rating-event-group">
							</div>
						</div>
					</div>
					<communities-component-communityEvents  is="communities-component-communityEvents" v-for="item in communityData.Events" v-bind:item="item" v-bind:key="item.name"></communities-component-communityEvents>
				</div>					
			</div>
			<div id="newCommunityEvent" class="dialog-place" v-bind:class="{ 'menu-collapsed': currentView != 11 }">
				<div class="dialog">
					<div class="menu-row">
						<div class="dialog-caption">{{language.menuCommunityEventsNew}}</div>
						<div class="dialog-close" v-on:click="changeView(10)"><svg viewbox="0 0 40 40"><path class="close-x" d="M 10,10 L 30,30 M 30,10 L 10,30" /></svg></div>
					</div>
					<div class="menu-row">
						<input class="menu-key menu-input-key" :placeholder="language.createCommunityEvent" maxlength="20" v-model="newCommunityEvent"/>
					</div>
					<div class="menu-row">
						<div id="createCommunityEventError" class="dialog-error"></div>
					</div>
					<div class="menu-row">
						<a class="loginButton" href="_" v-on:click="createCommunityEvent(); event.preventDefault();">{{language.createCommunityEventBtn}}</a>
					</div>
				</div>					
			</div>
			<div id="createCommunity" class="dialog-place" v-bind:class="{ 'menu-collapsed': currentView != 5 }">
				<div class="dialog">
					<div class="menu-row">
						<div class="dialog-caption">{{language.createCommunity}}</div>
						<div class="dialog-close" v-on:click="changeView(0)"><svg viewbox="0 0 40 40"><path class="close-x" d="M 10,10 L 30,30 M 30,10 L 10,30" /></svg></div>
					</div>
					<div class="dialog-content">
						<div class="menu-row">
							<select class="menu-key menu-select-key" id="newCommunityRegion" v-model="newCommunityRegion">
							</select>
						</div>
						<div class="menu-row">
							<input class="menu-key menu-input-key" :placeholder="language.createCommunityCity" maxlength="20" v-model="newCommunityCity"/>
						</div>
						<div class="menu-row">
							<input class="menu-key menu-input-key" :placeholder="language.createCommunityName" maxlength="20" v-model="newCommunityName"/>
						</div>
						<div class="menu-row">
							<div id="createCommunityError" class="dialog-error"></div>
						</div>
						<div class="menu-row">
							<a class="loginButton" href="_" v-on:click="createCommunity(); event.preventDefault();">{{language.createCommunityBtn}}</a>
						</div>
					</div>	
				</div>
			</div>
			<div id="courtCommunity" class="dialog-place" v-bind:class="{ 'menu-collapsed': currentView != 6 }">
				<div class="dialog">
					<div class="menu-row">
						<div class="dialog-caption">{{language.courtCommunity}}</div>
						<div class="dialog-close" v-on:click="changeView(0)"><svg viewbox="0 0 40 40"><path class="close-x" d="M 10,10 L 30,30 M 30,10 L 10,30" /></svg></div>
					</div>
					<div class="dialog-content">
						<div class="menu-row">
							<select class="menu-key menu-select-key" id="courtCommunityName" v-model="courtCommunityName"></select>
						</div>
						<div class="menu-row">
							<div id="courtCommunityError" class="dialog-error"></div>
						</div>
						<div class="menu-row">
							<!--<a class="loginButton" href="_" v-on:click="requestCommunitiesList(); event.preventDefault();">{{language.refresh}}</a>-->
							<a class="loginButton" href="_" v-on:click="courtCommunity(); event.preventDefault();">{{language.courtCommunityBtn}}</a>
						</div>
					</div>	
				</div>
			</div>
			<div id="changeCommunity" class="dialog-place" v-bind:class="{ 'menu-collapsed': currentView != 7 }">
				<div class="dialog">
					<div class="menu-row">
						<div class="dialog-caption">{{language.changeCommunity}}</div>
						<div class="dialog-close" v-on:click="changeView(0)"><svg viewbox="0 0 40 40"><path class="close-x" d="M 10,10 L 30,30 M 30,10 L 10,30" /></svg></div>
					</div>
					<div class="dialog-content">
						<div class="menu-row">
							<select class="menu-key menu-select-key" id="changeCommunityName" v-bind="community"></select>
						</div>
						<div class="menu-row">
							<div id="changeCommunityError" class="dialog-error"></div>
						</div>
						<div class="menu-row">
							<a class="loginButton" href="_" v-on:click="selectCommunity(); event.preventDefault();">{{language.changeCommunityBtn}}</a>
						</div>
					</div>	
				</div>
			</div>
			<div id="communities" class="profile" v-bind:class="{ 'menu-collapsed': currentView != 4 }">
				<div class="history-container">
					<communities-component-waitingAgreement  is="communities-component-waitingAgreement" v-for="item in waitingAgreement" v-bind:item="item" v-bind:key="item.name"></communities-component-waitingAgreement>
					<communities-component-waitingJoining  is="communities-component-waitingJoining" v-for="item in waitingJoining" v-bind:item="item" v-bind:key="item.name"></communities-component-waitingJoining>
				</div>
				<div class="emptyMessage">
					<div v-bind:class="{ 'menu-collapsed': waitingAgreement.length != 0 || waitingJoining.length != 0 }">{{language.noEvents}}</div>
				</div>
			</div> 
			<div id="profile" class="profile" v-bind:class="{ 'menu-collapsed': currentView != 3 }">
				<div class="history-container">
					<div>World stats</div>
					<div class="scoring-throws-group">
						<profile-stats-component  is="profile-stats-component" v-for="item in userWorldStats" v-bind:item="item" v-bind:key="item.name"></profile-stats-component>
					</div>
					<div v-bind:class="{ 'menu-collapsed': !userName || !community}">{{community}}</div>
					<div class="scoring-throws-group" v-bind:class="{ 'menu-collapsed': !userName || !community}">
						<profile-stats-component  is="profile-stats-component" v-for="item in userCommunityStats" v-bind:item="item" v-bind:key="item.name"></profile-stats-component>
					</div>
					<div>{{language.weeklyRating}}</div>
					<div class="scoring-throws-group">
						<canvas id="weeklyChart" class="weeklyChart"></canvas>
					</div>
				</div>
			</div> 
			<div id="history" class="history" v-bind:class="{ 'menu-collapsed': currentView != 1 }">
				<div class="history-container">
					<div class="history-data">
						{{language.historyTotal}} {{history.length}}
						<history-component  is="history-component" v-for="item in history" kind="history" v-bind:item="item" v-bind:key="item.timeStamp"></history-component>
					</div>
				</div>
			</div>
			<div id="historyGame" class="history" v-bind:class="{ 'menu-collapsed': currentView != 2 }">
				<div class="history-container">
					<div class="history-data">
						<history-component  is="history-component" v-for="item in historyItemList" v-bind:item="item" v-bind:key="item.timeStamp">
						</history-component>
						<game-set-component is="game-set-component" v-for="item in historyItemLegs" v-bind:item="item" v-bind:key="item.leg">
						</game-set-component>
					</div>
				</div>
			</div>
			<div id="publishGame" class="dialog-place" v-bind:class="{ 'menu-collapsed': currentView != 12 }">
				<div class="dialog">
					<div class="menu-row">
						<div class="dialog-caption">{{language.publishGame}}</div>
					</div>
					<div class="dialog-content">
						<div class="menu-row">
							<div class="community-rating-userName">{{language.publishWin}} {{game.winner}}</div>
						</div>
						<div class="menu-row">
							<div id="publishGameError" class="dialog-error"></div>
						</div>
						<div class="menu-row">
							<a class="loginButton" href="_" v-on:click="publishGame(); event.preventDefault();">{{language.publishGameBtn}}</a>
							<a class="loginButton" href="_" v-on:click="keyboardDelete(); changeView(0); event.preventDefault();">{{language.publishGameUndoBtn}}</a>
						</div>
					</div>	
				</div>
			</div>
			<div id="dartsGame" class="dartsGame" v-bind:class="{ 'menu-collapsed': currentView != 0 }">
				<div id="keyboard">
					<div id="keyboard-keys">
						<div id="keyboard-menu" class="keyboard-menu" v-bind:class="{ 'menu-collapsed': !menuShown }">
							<div class="menu-empty"></div>
								<div class="menu-row menu-entering-collapsed">
									<div class="menu-key-checkable" v-bind:class="{ 'menu-game-length-checked': newNoStartSwap }" v-on:click="menuKeyClick('noStartSwap')">{{language.menuNoStartSwap}}</div>
								</div>
								<div class="menu-row">
									<div class="menu-text"><label for="eventName" class="menu-text-span">{{language.menuEventName}}</label></div>
									<select class="menu-input" id="eventName" v-model="game.eventName">
									</select>
								</div>
								<div class="menu-row">
									<div class="menu-text"><label for="player1" class="menu-text-span">{{language.menuFirstPlayer}}</label></div>
									<select class="menu-input" id="player1" v-model="game.player1">
									</select>
								</div>
								<div class="menu-row">
									<div class="menu-text"><label for="player2" class="menu-text-span">{{language.menuSecondPlayer}}</label></div>
									<select class="menu-input" id="player2" v-model="game.player2">
									</select>
								</div>
								<div class="menu-row menu-entering-collapsed">
									<div class="menu-text"><div class="menu-text-span"></div>{{language.menuGame}}</span></div>
									<div class="menu-options-row-group"> 
										<div class="menu-options-row">
											<div class="menu-inc-key" v-on:click="menuKeyClick('gameMinus')">-</div>
											<div class="menu-number-key">{{newGameLength}}</div>
											<div class="menu-inc-key" v-on:click="menuKeyClick('gamePlus')">+</div>
										</div>
									</div>
								</div>
								<div class="menu-row menu-entering-collapsed">
									<div class="menu-text"><div class="menu-text-span"></div>{{language.menuSets}}</span></div>
									<div class="menu-options-row">
										<div class="menu-inc-key" v-on:click="menuKeyClick('setMinus')">-</div>
										<div class="menu-number-key">{{newSetLength}}</div>
										<div class="menu-inc-key" v-on:click="menuKeyClick('setPlus')">+</div>
									</div>
								</div>
								<div class="menu-row menu-entering-collapsed">
									<div class="menu-text"><div class="menu-text-span"></div>{{language.menuLegs}}</span></div>
									<div class="menu-options-row">
										<div class="menu-inc-key" v-on:click="menuKeyClick('legMinus')">-</div>
										<div class="menu-number-key">{{newLegLength}}</div>
										<div class="menu-inc-key" v-on:click="menuKeyClick('legPlus')">+</div>
									</div>
								</div>
								<div class="menu-row menu-entering-collapsed">
									<div class="menu-key" v-bind:class="{ 'menu-disabled': !(game.player1 && game.player2 && game.eventName && game.player1 != game.player2) }" v-on:click="newGame()">{{language.menuNewGame}}</div>
								</div>
								<div class="menu-row menu-entering-collapsed">
										<div class="menu-key" v-bind:class="{ 'menu-disabled': !(game.player1 && game.player2 && game.eventName && game.player1 != game.player2) }" v-on:click="menuShown = !(game.player1 && game.player2 && game.eventName && game.player1 != game.player2); game.eventName = eventName;">{{language.menuContinue}}</div>
								</div>
								<!--<div class="menu-row menu-entering-collapsed">
									<div class="menu-text menu-text-ver">v.1.01</div>
								</div>-->
								<div class="menu-empty"></div>
						</div>
						<div id="keyboard-numbers" class="keyboard-numbers" v-bind:class="{ 'element-collapsed': menuShown }">
							<div class="keyboard-row">
								<div class="regular-key" id="key1" v-on:click="keyboardClick(1)"> 1 </div>
								<div class="regular-key" id="key2" v-on:click="keyboardClick(2)"> 2 </div>
								<div class="regular-key" id="key3" v-on:click="keyboardClick(3)"> 3 </div>
							</div>
							<div class="keyboard-row">
								<div class="regular-key" id="key4" v-on:click="keyboardClick(4)"> 4 </div>
								<div class="regular-key" id="key5" v-on:click="keyboardClick(5)"> 5 </div>
								<div class="regular-key" id="key6" v-on:click="keyboardClick(6)"> 6 </div>
							</div>
							<div class="keyboard-row">
								<div class="regular-key" id="key7" v-on:click="keyboardClick(7)"> 7 </div>
								<div class="regular-key" id="key8" v-on:click="keyboardClick(8)"> 8 </div>
								<div class="regular-key" id="key9" v-on:click="keyboardClick(9)"> 9 </div>
							</div>
							<div class="keyboard-row">
								<div class="regular-key" id="keyC" v-on:click="showMenu"> M </div>
								<div class="regular-key" id="key0" v-on:click="keyboardClick(0)"> 0 </div>
								<div class="regular-key" id="keyD" v-on:click="keyboardDelete"> ↶ </div>
							</div>
						</div>
						<div id="keyboard-score" class="keyboard-score" v-bind:class="{ 'element-collapsed': menuShown }">
							<div class="keyboard-row">
								<div class="score-key" id="keyScore">{{value}}</div>
							</div>
							<div class="keyboard-row">
								<div class="score-ok-key" id="keyOk" v-on:click="keyboardOk" v-longpress="keyboardLongOk">Ok</div>
							</div>
							<div class="keyboard-score-row" v-bind:class="{ 'element-hidden': disabledCloses >= 3 }">
								<div class="score-double-key" v-bind:class="{ 'score-double-key-checked': doubles >= 1, 'score-double-key-disabled': disabledDoubles >= 3 }" v-on:click="doubles = disabledDoubles >= 3 ? doubles : (doubles >= 1 ? 0 : 1)"> </div>
								<div class="score-double-key" v-bind:class="{ 'score-double-key-checked': doubles >= 2, 'score-double-key-disabled': disabledDoubles >= 2 }" v-on:click="doubles = disabledDoubles >= 2 ? doubles : 2"> </div>
								<div class="score-double-key" v-bind:class="{ 'score-double-key-checked': doubles >= 3, 'score-double-key-disabled': disabledDoubles >= 1 }" v-on:click="doubles = disabledDoubles >= 1 ? doubles : 3"> </div>
							</div>
							<div class="keyboard-score-row" v-bind:class="{ 'element-hidden': disabledCloses >= 3 }">
								<div class="score-x-key" v-bind:class="{ 'score-x-key-checked': closes >= 1, 'score-x-key-disabled': disabledCloses >= 1 }" v-on:click="keyboardClose(1)">X1</div>
								<div class="score-x-key" v-bind:class="{ 'score-x-key-checked': closes >= 2, 'score-x-key-disabled': disabledCloses >= 2 }" v-on:click="keyboardClose(2)">X2</div>
								<div class="score-x-key" v-bind:class="{ 'score-x-key-checked': closes >= 3, 'score-x-key-disabled': disabledCloses >= 3 }" v-on:click="keyboardClose(3)">X3</div>
							</div>
						</div>
					</div>
					<div class="keyboard-stats" v-bind:class="{ 'element-collapsed': menuShown }">
						<div id="stats-list" class="keyboard-stats-list">
							<stats-component is="stats-component" v-for="item in stats" v-bind:item="item" v-bind:key="item.name">
							</stats-component>
						</div>
					</div>
				</div>
				<div id="scoring" class="scoring">
					<div id="game-component">
							<div id="scoring-data" class="scoring-data"> <!-- v-swipe="swipeLeg"-->
								<div id="scoring-left" class="marker-view" v-bind:class="{ 'element-collapsed': !markerView || game.finished }">
									<div class="marker-view-score" v-bind:class="{ 'scoring-throw-next': legs[legs.length - 1].next == 1 }">{{legs[legs.length - 1].left1}}</div>
										<div class="marker-view-score" v-bind:class="{ 'scoring-throw-next': legs[legs.length - 1].next == 2 }">{{legs[legs.length - 1].left2}}</div>
									</div>
									<div class="scoring-head">
									<div class="scoring-player" v-on:click="prev">{{legs[legN].player1}}</div>
									<div class="scoring-leg" v-bind:class="{ 'element-collapsed': showSeparator }">
											{{language.leg}} {{legs[legN].leg + 1}}
									</div>
									<div class="scoring-leg-group" v-bind:class="{ 'element-collapsed': !showSeparator }">
										<div class="scoring-leg">
											{{language.set}} {{legs[legN].set + 1}}
										</div>
										<div class="scoring-leg-separator"></div>
										<div class="scoring-leg">
											{{language.leg}} {{legs[legN].leg + 1}}
										</div>
									</div>
									<div class="scoring-player" v-on:click="next">{{legs[legN].player2}}</div>
								</div>
								<div id="scoring-throws">
									<div id="scoring-throws-group">
										<game-leg-component is="game-leg-component" v-for="item in legs[legN].throws" v-bind:item="item" v-bind:key="item.name">
										</game-leg-component>
										<div class="scoring-throws-space"></div>
									</div>
								</div>
							</div>
					</div>
					<div class="keyboard-stats" v-bind:class="{ 'element-collapsed': menuShown }">
						<div id="scoring-stats" class="keyboard-stats-list">
							<div class="stat-game-way-player"> 
									<div class="stat-game-way-head">{{gameStat.name}}</div>
									<div class="stat-game-way">{{gameStat.player1}}</div>
									<div class="stat-game-way">{{gameStat.player2}}</div>
							</div>
							<game-way-component is="game-way-component" v-for="item in statsSetLeg" v-bind:item="item" v-bind:key="item.name">
							</game-way-component>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script defer async>
			var keyboardKeys;
			var banner;
			function deleteAllCookies() {
				var cookies = document.cookie.split(";");
				for (let i = 0; i < cookies.length; i++) {
					var cookie = cookies[i];
					var eqPos = cookie.indexOf("=");
					var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
					document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
				}
			}
			function validateThrow(value, left) {
				if(value < 0 || value > 180)
					return false;
				if(value == 179 || value == 178 || value == 176 || value == 175 || value == 173 || 
					value == 172 || value == 169 || value == 166 || value == 163)
					return false;
				if(value >= left)
					return false;
				if(left - value < 2)
					return false;
				return true;
			}
			var game = {
					timeStamp: new Date(),
					eventName: undefined,
					player1: undefined,
					player2: undefined,
					winner: undefined,
					setLength: 1,
					legLength: 3,
					gameLength: 501,
					gameType: "501",
					noStartSwap: false,
					step: 0,
					wonSets1: 0,
					wonSets2: 0,
					legs: [],
					game: [ 
						[//set
							{//leg
								firstThrows: [],
								secondThrows: []
							}
						] 
					],
					stats: [],
					lastLeg : [],
					storeCurrentState: function () {
						setRecord("CurrentGame", this.step, JSON.stringify(this));
					},
					restoreLastState: function () {
						getLastRecord("CurrentGame", function(v) {
							if(!v) {
								game.game = [ 
									[//set
										{//leg
											firstThrows: [],
											secondThrows: []
										}
									]
								];
								game.updateAll();
								return;
							}
							var g = JSON.parse(v);
							game.timeStamp = new Date(g.timeStamp);
							game.finished = g.finished;
							game.player1 = g.player1;
							game.player2 = g.player2;
							game.eventName = g.eventName;
							game.setLength = g.setLength;
							game.legLength = g.legLength;
							game.gameLength = g.gameLength;
							game.noStartSwap = g.noStartSwap;
							game.step = g.step;
							game.game = g.game;
							game.legs = g.legs;
							game.updateAll();
						});
					},
					undo: function() {
						if(this.step == 0) return;
						deleteRecord("CurrentGame", this.step);
						this.restoreLastState();
					},
					updateStats: function() {
						let s = Game501.Verify(this);//.filter(e=>["100+", "140+", "180", "Av", "HC", "Dbls", "%", "Best", "LWAT"].find(e.name));					
						keyboardKeys.stats =  this.stats = [s["100+"], s["140+"], s["180"], s["Av"], s["HC"], s["Dbls"], s["%"], s["Best"], s["LWAT"]];
					},
					updateAll: function() {
						game.lastLeg = Game501.getVisualLeg(game, game.game.length - 1, game.game[game.game.length - 1].length - 1);
						game.updateStats();
						var res = Game501.GetLegs(game);
						keyboardKeys.showSeparator = game.setLength > 1;
						keyboardKeys.legN = res.length - 1;
						game.legs = keyboardKeys.legs = res;
						keyboardKeys.newGameLength = settings.newGameLength;
						keyboardKeys.newLegLength = settings.newLegLength;
						keyboardKeys.newSetLength = settings.newSetLength;
						keyboardKeys.newNoStartSwap = settings.newNoStartSwap;
						keyboardKeys.languageName = settings.language;
						keyboardKeys.language = languages[settings.language];
						keyboardKeys.endings = settings.endings;
						keyboardKeys.game = game;
						keyboardKeys.doubles = Math.max(keyboardKeys.doubles, game.minimumDoubles());
						keyboardKeys.minimumDoubles = game.minimumDoubles();
						keyboardKeys.disabledCloses = game.disabledCloses();
						keyboardKeys.disabledDoubles = game.disabledDoubles();
						keyboardKeys.closes = 0;
						keyboardKeys.doubles = 0;

						keyboardKeys.legN = keyboardKeys.legs.length - 1;
						keyboardKeys.gameStat = { 
							name: "Best of " + game.setLength + " sets of " + game.legLength + " legs", 
							player1: settings.getEnding(this.lastLeg.left1, game.player1), 
							player2: settings.getEnding(this.lastLeg.left2, game.player2)
						},
						keyboardKeys.statsSetLeg = [
												{ name: keyboardKeys.language.sets, player1: game.wonSets1, player2: game.wonSets2 },
												{ name: keyboardKeys.language.legs, player1: game.game[game.game.length - 1].wonLegs1, player2: game.game[game.game.length - 1].wonLegs2 },
											];
						keyboardKeys.scrollToView();
					},
					nextThrow: function(value) {
						if(!this.lastLeg || this.lastLeg.next == 0) return;
						var t = this.lastLeg.throws;
						var s = this.game[this.game.length - 1];
						if(t[t.length-1].next == 1)
							s[s.length - 1].firstThrows.push(value);
						else
							s[s.length - 1].secondThrows.push(value);
						this.step++;
					},
					newLeg: async function() {
						if(this.lastLeg.next != 0) return;
						game.updateAll();
						var s = this.game[this.game.length - 1];
						if(s.wonLegs1 >  Math.floor(this.legLength / 2) || s.wonLegs2 >  Math.floor(this.legLength / 2) || s.length >= this.legLength) {
							if(game.finished) {
								setRecord("History", this.timeStamp, JSON.stringify(this));
								keyboardKeys.changeView(12);
								return;
							}
							this.game.push([]);
						}
						this.game[this.game.length - 1].push({ firstThrows: [], secondThrows: [] });
					},
					actualLeft: function() {
						if(this.lastLeg.next == 0) return 0;
						if(this.lastLeg.next == 1)
							return this.lastLeg.left1;
						return this.lastLeg.left2;
					},
					validateNumber: function(value) {
						if(this.lastLeg.next == 0) return false;
						return value <= this.actualLeft();
					},
					minimumDoubles: function() {
						if(this.lastLeg.next == 0) return 0;
						return this.availableCloses() == 1 ? 1 : 0;
					},
					disabledCloses: function() {
						return this.availableCloses() - 1;
					},
					disabledDoubles: function() {
						return this.disabledCloses();
					},
					availableCloses: function() {
						if(this.lastLeg.next == 0) return 99;
						var left = this.actualLeft();
						if(minDartClose[left])
							return minDartClose[left];
						return 99;
					},
					isFirstStart: function(setN, legN) {
						if(this.noStartSwap)
							return true;
						return setN % 2 == 0 ? legN % 2 == 0 : legN % 2 != 0;
					}
				};
			var hostUrl = document.URL.split("/DartsForge/")[0];
			keyboardKeys = new Vue({
				el: "#app",
				data: {				
					wait: false,
					userName: undefined,
					communities: [],
					community: undefined,
					eventName: undefined,
					eventData: [],
					communityData: {
						CommunityRating: []
					},
					newCommunityRegion: "RU",
					newCommunityName: undefined,
					newCommunityCity: undefined, 
					newCommunityEvent: undefined,
					courtCommunityName: undefined,
					profile: {},
					userCommunityStats: {},
					userWorldStats: {},
					communitiesList: [],
					waitingAgreement: [],
					waitingJoining: [],
					markerView: true,
					language: languages[settings.language],
					languages: languages,
					languageName: settings.language,
					newSetLength: settings.newSetLength,
					newLegLength: settings.newLegLength,
					newGameLength: settings.newGameLength,
					newNoStartSwap: settings.newStartSwap,
					game: game,
					value: 0,
					doubles: 0,
					closes: 0,
					disabledDoubles: 0,
					disabledCloses: 0,
					minimumDoubles: 0,
					menuShown: true,
					currentView: 0,
					historyItemLegs: [],
					historyItemList: [],
					eventHistoryItemLegs: [],
					eventHistoryItemList: [{stats:[]}],
					stats: game.stats,
					endings: "Default",
					history: [],
					eventHistory: [],
					gameStat: { name: "Best of 1 sets of 5 legs", player1: "Player 1", player2: "Player 2" },
					statsSetLeg: [
						{ name: "Sets", player1: "0", player2: "0", width: 1 },
						{ name: "Legs", player1: "0", player2: "0", width: 1 },
					],
					showSeparator: false,
					legN: 0,
					legs: [ {
								player1: game.player1,
								player2: game.player2,
								set: 0,
								leg: 0,
								left1: game.gameLength,
								left2: game.gameLength,
								throw: 0,
								startsFirst: true,
								next: 0,		
								throws: [
									{
										throw1: "",
										left1: game.gameLength, 
										throw2: "",
										left2: game.gameLength,
										throw: 0
									}
								]
							} ]
				},
				watch: {
					'game.player1': function(val, preVal){
						game.updateAll();
					},
					'game.player2': function(val, preVal){
						game.updateAll();
					},
				},
				methods: {
					updateAll: function() {
						game.updateAll();
					},
					prev: function() {
						this.legN--;
						if(this.legN < 0)
							this.legN = 0;
						else {
							var elm = document.getElementById("scoring-data");
							elm.classList.remove("animSwipeRight");
							elm.classList.remove("animSwipeLeft");
							void elm.offsetWidth;
							elm.classList.add("animSwipeRight");
						}
					},
					next: function() {
						this.legN++;
						if(this.legN >= this.legs.length)
							this.legN = this.legs.length - 1;
						else {
							var elm = document.getElementById("scoring-data");
							elm.classList.remove("animSwipeLeft");
							elm.classList.remove("animSwipeRight");
							void elm.offsetWidth;
							elm.classList.add("animSwipeLeft");
						}
					},
					swipeLeg: function(e) {
						if(e.detail.moving) {
							if(e.detail.dir == "up")
								document.getElementById("scoring-throws").scrollTop += e.detail.dist;
							if(e.detail.dir == "down")
								document.getElementById("scoring-throws").scrollTop -= e.detail.dist;
						} else {
							if(e.detail.dir == "right")
								this.prev();
							if(e.detail.dir == "left")
								this.next();
						}
					},
					showMenu: function() {
						this.menuShown = true;
						var elm = document.getElementById("keyScore");
						elm.classList.remove("animError");
					},
					keyboardClick: function (value) {
						var v = this.value * 10 + value;
						if(v > 180)
							v = 0;
						if(!game.validateNumber(v))
							v = 0;
						this.value = v;
						this.legN = this.legs.length - 1;
					},
					changeEnding: function() {
						let k = Object.keys(endings);
						let i = k.indexOf(this.endings) + 1;
						if(i >= k.length)
							i = 0;
						settings.endings = this.endings = k[i];
						settings.store();
						game.updateAll();
					},
					changeMarkerView: function() {
						this.markerView = settings.markerView = !this.markerView;
						settings.store();
					},
					changeLanguage : function() {
						let k = Object.keys(languages);
						let i = k.indexOf(this.languageName) + 1;
						if(i >= k.length)
							i = 0;
						settings.language = this.languageName = k[i];
						banner.language = this.language = languages[this.languageName];
						settings.store();
						game.updateAll();
					},
					showEventHistory: async function(event) {
						this.eventData = event;
						this.eventName = event.EventName;
						this.eventHistory = (await DartsApi({ action: "getEvent",
								name: this.community,
								eventName: this.eventName })).map(e=> {
									Game501.ConvertNames(e);
									let s = Game501.Verify(e);
									e.legs = Game501.GetLegs(e);
									e.stats = [s["100+"], s["140+"], s["180"], s["Av"], s["HC"], s["Dbls"], s["%"], s["Best"], s["LWAT"]];;
									return e;
								});
						this.changeView(13);
					},
					showEventHistoryItem: function(t) {
						this.changeView(14);
						var eventHistoryItem = this.eventHistory.find((i) => { return i.timeStamp == t});
						this.eventHistoryItemLegs = eventHistoryItem.legs;
						this.eventHistoryItemList = [eventHistoryItem];
					},
					showHistory: function() {
						var to = new Date();
						var from = new Date();
						from.setDate(from.getDate() - 365);
						getRecords("History", from, to, function(r) {
							keyboardKeys.history = r.reverse();
						});
						this.changeView(1);
					},
					showHistoryItem: function(t) {
						this.changeView(2);
						var historyItem = this.history.find((i) => { return i.timeStamp == t});
						this.historyItemLegs = historyItem.legs;
						this.historyItemList = [historyItem];
					},
					newGame: function() {
						if(!(game.player1 && game.player2 && game.eventName && game.player1 != game.player2))
							return;
						game.finished = false;
						game.timeStamp = new Date();
						game.setLength = this.newSetLength;
						game.legLength = this.newLegLength;
						game.gameLength = this.newGameLength;
						game.noStartSwap = this.newNoStartSwap;
						game.game = [ 
									[//set
										{//leg
											firstThrows: [],
											secondThrows: []
										}
									]
								];
						deleteAll("CurrentGame");
						game.updateAll();
						this.menuShown = false;
					},
					menuKeyClick: function(value) {
						gameLengths = [ 101, 301, 501, 701, 1001, 2001 ];
						if(value == "gameMinus") {
							let i = gameLengths.indexOf(this.newGameLength);
							if(i > 0)
								settings.newGameLength = this.newGameLength = gameLengths[i - 1];
						}
						if(value == "gamePlus") {
							let i = gameLengths.indexOf(this.newGameLength);
							if(i < gameLengths.length - 1)
								settings.newGameLength = this.newGameLength = gameLengths[i + 1];
						}
						if(value == "setMinus")
							settings.newSetLength = this.newSetLength = Math.max(1, this.newSetLength - 1);
						if(value == "setPlus")
							settings.newSetLength = this.newSetLength = Math.min(10, this.newSetLength + 1);
						if(value == "legMinus")
							settings.newLegLength = this.newLegLength = Math.max(1, this.newLegLength - 1);
						if(value == "legPlus")
							settings.newLegLength = this.newLegLength = Math.min(20, this.newLegLength + 1);
						if(value == "noStartSwap")
							settings.newNoStartSwap = this.newNoStartSwap = !this.newNoStartSwap;
						settings.store();
					},
					keyboardDelete: function() {
						if(this.wait)
							return;
						game.undo();
					},
					keyboardClose: function(x) {
						this.closes = this.disabledCloses >= x ? this.closes : (this.disabledCloses == x - 1 && this.closes > x - 1 ? 0 : x);
						if(this.closes > 0)
							this.doubles = Math.max(this.doubles, 1);
					},
					showError: function() {
						var elm = document.getElementById("keyScore");
						elm.classList.remove("animError");
						void elm.offsetWidth;
						elm.classList.add("animError");
					},
					keyboardLongOk() {
						if(game.lastLeg.next == 0) return;
						var left = game.lastLeg.next == 1 ? game.lastLeg.left1 : game.lastLeg.left2;
						var v = left - this.value;
						this.value = v;
						if(!validateThrow(this.value, left)) {
							this.showError();
							game.updateAll();
							this.game = game;
							this.value = 0;
							this.closes = 0;
						}
					},
					keyboardOk: function() {
						if(game.lastLeg.throws.next == 0) return;
						var t = game.lastLeg.throws;
						var s = game.game[game.game.length - 1];
						if(this.closes > 0) {
							if(this.closes >= game.availableCloses()) {
								game.nextThrow(this.closes * 10000 + this.doubles * 1000 + game.actualLeft());
								game.lastLeg.next = 0;
								game.newLeg();
							}
						} else {
							if(game.lastLeg.next == 0) return;
							if(validateThrow(this.value, game.lastLeg.next == 1 ? game.lastLeg.left1 : game.lastLeg.left2))
								game.nextThrow(this.doubles * 1000 + this.value);
							else {
								this.showError();
							}
						}
						game.updateAll();
						this.game = game;
						this.value = 0;
						this.closes = 0;
						this.doubles = game.minimumDoubles();
						this.minimumDoubles = game.minimumDoubles();
						this.disabledCloses = game.disabledCloses();
						this.disabledDoubles = game.disabledDoubles();
						this.legN = this.legs.length - 1;
						this.scrollToView();
						game.storeCurrentState();
					},
					scrollToView: function() {
						var element = document.getElementById("scoring-throws");
						if(element)
					    	element.scrollTop = element.scrollHeight;
					},
					getViewName() {
						let name = "";
						switch(this.currentView) {
							case 0: return this.language.menuInGame;
							case 1: return this.language.menuHistory;
							case 2: return this.language.menuHistory;
							case 3: return this.language.menuProfile;
							case 4: return this.language.communitiesNews;
							case 5: return this.language.createCommunity;
							case 6: return this.language.courtCommunity;
							case 8: return this.language.communityRating;
							case 10: return this.language.menuCommunityEvents;
							case 11: return this.language.menuCommunityEventsNew;
							case 12: return this.language.publishGame;
							case 13: return this.language.menuEvent;
							case 14: return this.language.menuEventGame;
						}
					},
					changeView: function(view) {
						this.currentView = view;
						var elm = document.getElementById("scoring-data");
						elm.classList.remove("animSwipeRight");
						elm.classList.remove("animSwipeLeft");
						if(this.currentView != 12)
							window.history.pushState({currentView: this.currentView}, "DartsForge: " + this.getViewName(), window.location.URL);
					},
					changeViewBack: function() {
						window.history.back();
					},
					requestCommunitiesList: async function() {
						settings.communities = keyboardKeys.communities = await DartsApi({ action: 'getCommunities' });
						settings.store();
						this.fillCommunitiesList();
					},
					fillCommunitiesList: async function () {
						var r = document.getElementById("courtCommunityName");
						if(!r) return;
						r.innerHTML = "";
						for (i = r.options.length - 1; i >= 0 ; i--)
							r.options[i] = null;
						for (let i = 0; i < settings.communities.length; i++) {
							var opt = document.createElement('option');
							opt.value = settings.communities[i].Name;
							opt.innerHTML = settings.communities[i].Name + ' (' + settings.communities[i].Region +')';
							r.appendChild(opt);
						}
						if(r.selectedIndex >= 0)
							this.courtCommunityName = r.options[r.selectedIndex].value;
					},
					refreshProfle: async function() {
						this.profile = await DartsApiProfile();
						await this.updateCommunityData();
						this.communitiesList = this.profile.OwnedCommunities.concat(this.profile.JoinedCommunities);
						if(this.profile.Courts)
							this.waitingAgreement = this.profile.Courts.map(e=>{ e.language = keyboardKeys.language; return e; });
						if(this.profile.Joins)
							this.waitingJoining = this.profile.Joins.map(e=>{ e.language = keyboardKeys.language; return e; });
						var r = document.getElementById("changeCommunityName");
						if(!r) return;
						r.innerHTML = "";
						for (i = r.options.length - 1; i >= 0 ; i--)
							r.options[i] = null;
						for (let i = 0; i < this.communitiesList.length; i++) {
							var opt = document.createElement('option');
							opt.value = this.communitiesList[i];
							opt.innerHTML = this.communitiesList[i];
							r.appendChild(opt);
						}
						if(!this.communityData.Rating || !this.communityData.Rating.findIndex(e=>e.UserName == this.userName))
							this.community = settings.community = null;
						let stats = this.profile.WorldRating;
						if(stats)
							this.userWorldStats = [
								{name: "W/D/L", value: stats.WonGames + "/" + stats.DrawGames + "/" + stats.LooseGames},	
								{name: "60+", value: stats.t60},
								{name: "100+", value: stats.t100},
								{name: "140+", value: stats.t140},
								{name: "180+", value: stats.t180},	
								{name: "HC", value: stats.HC},	
								{name: "BL", value: stats.BestLeg},	
//								{name: "LWAT", value: stats.LWAT},	
//								{name: "WL", value: stats.WonLegs},	
								{name: "Dbls", value: stats.DoubleSuccess + "/" + stats.DoubleThrows},	
								{name: "Av", value: Math.round(stats.ThrowTotal / stats.ThrowCount)}
							];
							var ctx = document.getElementById('weeklyChart').getContext('2d');
							if(keyboardKeys.profile.WeeklyRating.length > 1)
								var weeklyChart = new Chart(ctx, {
									type: 'line',
									data: {
										labels: keyboardKeys.profile.WeeklyRating.map(e=> e.Week),
										datasets: [{
											label: "3 dart average",
											data: keyboardKeys.profile.WeeklyRating.map(e=> Math.round(e.ThrowTotal / e.ThrowCount))
										}]
									},
									options: {
										scales: {
											yAxes: [{
												ticks: {
													beginAtZero: true
												}
											}]
										}
									}
								});
					},
					createCommunity: async function() {
						var res = await DartsApi({
								action: 'newCommunity',
								region: this.newCommunityRegion, 
								city: this.newCommunityCity, 
								name: this.newCommunityName
							});
						var err = document.getElementById("createCommunityError");
						if(res.error) {
							err.innerHTML = res.error.message ? res.error.message : res.error;
						} else {
							await keyboardKeys.refreshProfle();
							err.innerHTML = "";
							this.changeView(0);
						}
					},
					createCommunityEvent: async function() {
						var res = await DartsApi({
								action: 'newCommunityEvent',
								eventName: this.newCommunityEvent, 
								name: this.community
							});
						var err = document.getElementById("createCommunityEventError");
						if(res.error) {
							err.innerHTML = res.error.message ? res.error.message : res.error;
						} else {
							await this.updateCommunityData();
							err.innerHTML = "";
							this.changeView(10);
						}
					},
					selectCommunity: async function() {
						var r = document.getElementById("changeCommunityName");
						this.community = settings.community = r.selectedIndex >= 0 ? r.options[r.selectedIndex].value : undefined;
						await this.updateCommunityData();
						settings.store();
						this.changeView(0);
					},
					updateCommunityData: async function() {
						if(this.community) {
							settings.communityData = this.communityData = await CommunityData(this.community);
							if(settings.communityData.error) {
								this.community = settings.community = undefined;
								return;
							}
							if(this.communityData.Rating)
								this.communityData.Rating = this.communityData.Rating.map(e=>{
									e.Rating = Math.round(e.Rating),
									e.Status = e.IsOwner ? this.language.userOwner 
											: e.IsReferee ? this.language.userReferee
											: this.language.userPlayer;
									e.changeable = e.UserName != this.userName && this.communityData.Owner == this.userName;
									return e;
								}).sort((a, b) => b.Rating < a.Rating ? -1 : 1);
							if(this.communityData.Events)
								this.communityData.Events = this.communityData.Events.map(e=>{
									let d = new Date(e.CreationDate)
									e.Date = d.getFullYear() + "/" + (d.getMonth() + 1) + "/" + d.getDate();
									e.Status = e.Active ? this.language.activeEvent 
											: this.language.inactiveEvent;
									e.changeable = this.communityData.Owner == this.userName || this.communityData.Referees.includes(this.userName);
									return e;
								}).sort((a, b) => b.Date < a.Date ? -1 : 1);

							var r = document.getElementById("eventName");
							for (i = r.options.length - 1; i >= 0 ; i--)
								r.options[i] = null;
							for (let i = 0; i < this.communityData.Events.length; i++) 
								if(this.communityData.Events[i].Active) {
									var opt = document.createElement('option');
									opt.innerHTML = this.communityData.Events[i].EventName;
									opt.value = this.communityData.Events[i].EventName;
									r.appendChild(opt);
								}
							var r = document.getElementById("player1");
							for (i = r.options.length - 1; i >= 0 ; i--)
								r.options[i] = null;
							for (let i = 0; i < this.communityData.Rating.length; i++) {
								var opt = document.createElement('option');
								opt.innerHTML = this.communityData.Rating[i].UserName + ' (Rating ' + Math.round(this.communityData.Rating[i].Rating) + ')';
								opt.value = this.communityData.Rating[i].UserName;
								r.appendChild(opt);
							}
							var r = document.getElementById("player2");
							for (i = r.options.length - 1; i >= 0 ; i--)
								r.options[i] = null;
							for (let i = 0; i < this.communityData.Rating.length; i++) {
								var opt = document.createElement('option');
								opt.innerHTML = this.communityData.Rating[i].UserName + ' (Rating ' + Math.round(this.communityData.Rating[i].Rating) + ')';
								opt.value = this.communityData.Rating[i].UserName;
								r.appendChild(opt);
							}
							let stats = this.communityData.Rating.find(e=>e.UserName == this.userName);
							let p =  this.communityData.Rating.findIndex(e=>e.UserName == this.userName) + 1;
							if(stats)
								this.userCommunityStats = [
									{name: "#", value: p},
									{name: "Rating", value: stats.Rating},
									{name: "W/D/L", value: stats.WonGames + "/" + stats.DrawGames + "/" + stats.LooseGames},	
									{name: "60+", value: stats.t60},
									{name: "100+", value: stats.t100},
									{name: "140+", value: stats.t140},
									{name: "180+", value: stats.t180},	
									{name: "HC", value: stats.HC},	
									{name: "BL", value: stats.BestLeg},	
//									{name: "LWAT", value: stats.LWAT},	
//									{name: "WonLegs", value: stats.WonLegs},
									{name: "Dbls", value: stats.DoubleSuccess + "/" + stats.DoubleThrows},	
									{name: "Av", value: Math.round(stats.ThrowTotal / stats.ThrowCount)}	
								];
						}
					},
					rejectCourt: async function(item) {
						var res = await DartsApi({
								action: 'rejectCourt',
								name: item.CommunityName
							});
						await keyboardKeys.refreshProfle();
					},
					rejectJoin: async function(item) {
						var res = await DartsApi({
								action: 'rejectJoin',
								name: item.CommunityName,
								courtName: item.UserName
							});
						await keyboardKeys.refreshProfle();
					},
					acceptJoin: async function(item) {
						var res = await DartsApi({
								action: 'joinCommunity',
								name: item.CommunityName,
								courtName: item.UserName
							});
						await keyboardKeys.refreshProfle();
					},
					courtCommunity: async function() {
						var res = await DartsApi({
								action: 'courtCommunity',
								name: this.courtCommunityName
							});
						var err = document.getElementById("courtCommunityError");
						if(res.error) {
							err.innerHTML = res.error.message ? res.error.message : res.error;
						} else {
							await keyboardKeys.refreshProfle();
							err.innerHTML = "";
							this.changeView(0);
						}
					},
					publishGame: async function() {
						if(this.wait)
							return;
						var res = await DartsApi({
								action: 'gameFinished',
								name: this.community,
								region: this.communityData.Region,
								eventName: this.eventName,
								gameData: JSON.stringify(game)
							});
						var err = document.getElementById("publishGameError");
						if(res.error) {
							err.innerHTML = res.error.message ? res.error.message : res.error;
						} else {
							await keyboardKeys.refreshProfle();
							err.innerHTML = "";					
							this.showHistory();
						}
					},
					logIn: function() {
						auth.getSession();
					},
					logOut: function() {
						settings.userName = undefined;
						settings.community = undefined;
						auth.signOut();
						window.location.replace('/DartsForge/');
					}
				}
			});
			banner = new Vue({
					el: "#installBanner",
					data: {
						language: languages[settings.language]
					},
					methods: {
						close: function() {

						}
					}
				});
			/*var swipeBlock = document.getElementById("scoring");
			swipe(swipeBlock, { maxTime: 1000, minTime: 100, maxDist: 150,  minDist: 60 });
			swipeBlock.addEventListener("swipe", function() {
				if(e.detail.swipeType == "right") {
					gameComponent.legN--;
					if(gameComponent.legN < 0)
						gameComponent.legN = 0;
				}
				if(e.detail.swipeType == "left") {
					gameComponent.legN++;
					if(gameComponent.legN >= gameComponent.legs.length)
						gameComponent.legN = gameComponent.legs.length - 1;
				}
			});
			*/
			function updateAll() {
				game.updateAll();
			}
			CreateObjectStore("Settings", function() {
				CreateObjectStore("CurrentGame", function() {
					CreateObjectStore("History", function() {
						game.restoreLastState();
						settings.restore();
						updateAll();
					});
				});
			});
			var app = document.getElementById("app");
			var keyPressTimer = null;
			var keyLongPress = false;
			document.onkeydown = e => {
				if (keyPressTimer === null)
					keyPressTimer = setTimeout(() => {
						keyLongPress = true;
					}, 1000);
			};
			document.onkeyup = e => {
				if (keyPressTimer !== null) {
					clearTimeout(keyPressTimer);
					keyPressTimer = null;
				}
				if(!keyboardKeys.menuShown && keyboardKeys.currentView == 0)
				switch(e.keyCode ? e.keyCode : e.keyChar) {
					case 48: case 96: case 45: keyboardKeys.keyboardClick(0);break;
					case 49: case 97: case 35: keyboardKeys.keyboardClick(1);break;
					case 50: case 98: case 40: keyboardKeys.keyboardClick(2);break;
					case 51: case 99: case 34: keyboardKeys.keyboardClick(3);break;
					case 52: case 100: case 37: keyboardKeys.keyboardClick(4);break;
					case 53: case 101: case 12: keyboardKeys.keyboardClick(5);break;
					case 54: case 102: case 39: keyboardKeys.keyboardClick(6);break;
					case 55: case 103: case 36: keyboardKeys.keyboardClick(7);break;
					case 56: case 104: case 38: keyboardKeys.keyboardClick(8);break;
					case 57: case 105: case 33: keyboardKeys.keyboardClick(9);break;
					case 13: keyLongPress ? keyboardKeys.keyboardLongOk() : keyboardKeys.keyboardOk();break;
					case 8: keyboardKeys.keyboardDelete();break;
					case 46: keyboardKeys.value = keyboardKeys.closes = keyboardKeys.doubles = 0; break;
					case 27: keyboardKeys.menuShown = true; break;
				}
				keyLongPress = false;
			};
			var r = document.getElementById("newCommunityRegion");
			for (let i = 0; i < flags.length; i++) {
				var opt = document.createElement('option');
			    opt.innerHTML = flags[i][1];
				opt.value = flags[i][0];
    			r.appendChild(opt);
			}
			if(settings.userName) 
				keyboardKeys.refreshProfle();
			window.fitText(document.getElementsByClassName("marker-view-score"), 0.2);


			function toggleMenuShow(element) {
				closeAllMenus();
				document.getElementById(element).classList.toggle("show");
			}
			window.onclick = function(event) {
				if (!event.target.matches('.menuelement')) closeAllMenus();
			}
			function closeAllMenus() {
				let dropdowns = document.getElementsByClassName("dropdown-content");
					for (let i = 0; i < dropdowns.length; i++) {
						let openDropdown = dropdowns[i];
						if (openDropdown.classList.contains('show')) 
							openDropdown.classList.remove('show');
					}
			}
			keyboardKeys.currentView = currentView;
			window.onpopstate = function(event) {
				keyboardKeys.currentView = event.state ? event.state.currentView : 0;
			};
			keyboardKeys.changeView(0);
		</script>
	</body>
</html>
